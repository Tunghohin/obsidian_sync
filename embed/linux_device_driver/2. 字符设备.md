## 2.1 设备号的申请与释放

#### 2.1.1使用如下函数来申请设备号
```c
int alloc_chrdev_region(dev_t *dev, unsigned baseminor, unsigned count, const char *name)
```
如果给定了设备的主设备号和次设备号就使用如下所示函数来注册设备号
```c
int register_chrdev_region(dev_t from, unsigned count, const char *name)
```

#### 2.1.2 统一使用以下下释放函数
```c
void unregister_chrdev_region(dev_t from, unsigned count)
```


## 2.2 字符设备结构

#### 2.2.1 Linux 中使用 cdev 结构体表示一个字符设备
```c
// include/linux/cdev.h
struct cdev {
	struct kobject kobj;
	struct module* owner;
	const struct file_operations* ops;
	struct list_head list;
	dev_t dev;
	unsigned int count;
}
```

#### 2.2.2 cdev_init cdev_add cdev_del

定义好 cdev 变量以后就要使用 cdev_init 函数对其进行初始化，cdev_init 函数原型如下
```c
//Initializes cdev, making it ready to add to the system with cdev_add()
void cdev_init(struct cdev *cdev, const struct file_operations *fops) {
	memset(cdev, 0, sizeof(*cdev));
	...
	cdev->ops = fops
}
```

使用 cdev_add 函数向 Linux 系统添加这个字符设备
```c
int cdev_add(struct cdev *p, dev_t dev, unsigned count)
```

卸载驱动的时候一定要使用 cdev_del 函数从 Linux 内核中删除相应的字符设备
```c
void cdev_del(struct cdev *p)
```

register_chrdev_region + cdev_init + cdev_add = register_chrdev
cdev_del + unregister_chrdev_region = unregister_chrdev

## 2.3 自动创建设备节点

#### 2.3.1 mdev 机制

设置热插拔事件由 mdev 来管理
```sh
echo /sbin/mdev > /proc/sys/kernel/hotplug
```

#### 2.3.2 创建和删除类

自动创建设备节点的工作是在驱动程序的入口函数中完成的，一般在 cdev_add 函数后面添
加自动创建设备节点相关代码。首先要创建一个 class 类
```c
#define class_create(owner, name) \
({ \
	static struct lock_class_key __key; \
	__class_create(owner, name, &__key); \
})

struct class* __class_create(struct module* owner, const char* name, struct lock_class_key* key)
```

卸载驱动程序的时候需要删除掉类，类删除函数为 class_destroy
```c
void class_destroy(struct class *cls);
```


#### 2.3.3 创建/删除设备

创建好类以后还不能实现自动创建设备节点，我们还需要在这个类下创建一个设
备
```c
struct device* device_create(struct class* class,
							 struct device* parent,
							 dev_t dev_id,
							 void* drvdata,
							 const char* fmt, // 设备名，生成/dev/xxx
							 ...
							)
```
卸载驱动的时候需要删除掉创建的设备
```c
void device_destroy(struct class *class, dev_t devt)
```

